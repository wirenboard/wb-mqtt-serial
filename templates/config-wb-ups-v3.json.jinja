{% set title_en = title_en | default("WB-UPS v.3 (Uninterruptible Power Supply)") -%}
{% set title_ru = title_ru | default("WB-UPS v.3 (модуль резервного питания)") -%}
{% set device_type = device_type | default("wb_ups_v3") -%}
{% set group = group | default("g-wb") -%}
{% set device_name = device_name | default("WB-UPS v.3") -%}
{% set device_id = device_id | default("wb_ups_v3") -%}

{
    "title": "template_title",
    "device_type": "{{ device_type }}",
    "group": "{{ group }}",
    "hw": [
        {
            "signature": "WB-UPS v.3"
        }
    ],
    "device": {
        "name": "{{ device_name }}",
        "id": "{{ device_id }}",
        "max_read_registers": 0,
        "response_timeout_ms": 1,
        "frame_timeout_ms": 8,
        "enable_wb_continuous_read": true,

        "groups": [
            {
                "title": "Uninterruptible Power Supply",
                "id": "g_ups"
            },
            {
                "title": "Output Voltage",
                "description": "g_output_voltage_description",
                "id": "gg_output_voltage",
                "group": "g_ups"
            },
            {
                "title": "UPS Channels",
                "id": "gg_ups_channels",
                "group": "g_ups",
                "ui_options": {
                    "wb": {
                        "disable_title": true
                    }
                }
            },
            {
                "title": "Button",
                "description": "g_button_description",
                "id": "g_button"
            },
            {
                "title": "General",
                "id": "general"
            },
            {
                "title": "HW Info",
                "id": "hw_info"
            },
            {
                "title": "Debug",
                "id": "debug"
            },
            {
                "title": "Heater",
                "id": "gg_debug_heater",
                "group": "debug"
            },
            {
                "title": "Charge/Discharge",
                "id": "gg_debug_charge_discharge",
                "group": "debug"
            },
            {
                "title": "Chip ADC Values",
                "id": "gg_debug_chip_adc",
                "group": "debug"
            }
        ],
        "parameters": [
            {
                "id": "output_voltage_control_mode",
                "title": "Mode",
                "address": 16,
                "reg_type": "holding",
                "enum": [0, 1],
                "default": 0,
                "enum_titles": [
                    "Automatic",
                    "Manual"
                ],
                "group": "gg_output_voltage",
                "order": 1
            },
            {
                "id": "output_voltage_setpoint",
                "title": "Output Voltage (V)",
                "address": 17,
                "reg_type": "holding",
                "min": 10.0,
                "max": 25.6,
                "default": 12.0,
                "scale": 0.001,
                "order": 2,
                "condition": "output_voltage_control_mode==1",
                "group": "gg_output_voltage"
            },
            {
                "id": "charging_current_setpoint",
                "title": "Charging Current (A)",
                "address": 18,
                "reg_type": "holding",
                "min": 0.3,
                "max": 2.0,
                "default": 0.6,
                "scale": 0.001,
                "order": 2,
                "group": "g_ups"
            },
            {
                "id": "baud_rate",
                "title": "Baud Rate",
                "description": "baud_rate_description",
                "address": 110,
                "reg_type": "holding",
                "enum": [96, 192, 384, 576, 1152],
                "default": 96,
                "enum_titles": [
                    "9600",
                    "19200",
                    "38400",
                    "57600",
                    "115200"
                ],
                "group": "general",
                "order": 1
            },
            {
                "id": "disable_indication",
                "title": "Status LED",
                "address": 130,
                "reg_type": "holding",
                "enum": [0, 1],
                "enum_titles": ["Enabled", "Disabled"],
                "default": 0,
                "group": "general"
            }
        ],
        "channels": [
            {
                "id": "battery_status",
                "name": "Battery Status",
                "read_only": true,
                "reg_type": "input",
                "address": 0,
                "enum": [0, 1, 2],
                "enum_titles": [
                    "Charging",
                    "Fully Charged",
                    "Discharging"
                ],
                "group": "gg_ups_channels"
            },
            {
                "id": "temperature_status",
                "name": "Temperature Status",
                "read_only": true,
                "reg_type": "input",
                "address": 1,
                "enum": [0, 1, 2, 3, 4],
                "enum_titles": [
                    "Normal",
                    "Cold, Not Working",
                    "Cold, Only Discharge",
                    "Overheat, Only Discharge",
                    "Overheat, Not Working"
                ],
                "group": "gg_ups_channels"
            },

            {
                "id": "input_voltage",
                "name": "Input Voltage",
                "units": "V",
                "scale": 0.001,
                "round_to": 0.01,
                "reg_type": "input",
                "address": 2,
                "group": "gg_ups_channels"
            },
            {
                "id": "output_voltage",
                "name": "Output Voltage",
                "units": "V",
                "scale": 0.001,
                "round_to": 0.01,
                "reg_type": "input",
                "address": 3,
                "group": "gg_ups_channels"
            },
            {
                "id": "battery_voltage",
                "name": "Battery Voltage",
                "units": "V",
                "scale": 0.001,
                "round_to": 0.001,
                "reg_type": "input",
                "address": 4,
                "group": "gg_ups_channels"
            },
            {
                "id": "battery_current",
                "name": "Battery Current",
                "units": "A",
                "scale": 0.001,
                "round_to": 0.001,
                "format": "s16",
                "reg_type": "input",
                "address": 5,
                "group": "gg_ups_channels"
            },
            {
                "id": "input_current_for_charging",
                "name": "Input Current for Charging",
                "units": "A",
                "scale": 0.001,
                "round_to": 0.001,
                "reg_type": "input",
                "address": 6,
                "group": "gg_ups_channels"
            },
            {
                "id": "load_current_when_powered_from_battery",
                "name": "Load Current when Powered from Battery",
                "units": "A",
                "scale": 0.001,
                "round_to": 0.001,
                "reg_type": "input",
                "address": 7,
                "group": "gg_ups_channels"
            },
            {
                "id": "battery_temperature",
                "name": "Battery Temperature",
                "units": "deg C",
                "scale": 0.01,
                "reg_type": "input",
                "address": 8,
                "group": "gg_ups_channels"
            },
            {
                "id": "battery_capacity",
                "name": "Battery Capacity",
                "units": "deg C",
                "scale": 0.01,
                "reg_type": "input",
                "address": 9,
                "group": "gg_ups_channels"
            },

            {
                "id": "button_state",
                "name": "Button State",
                "reg_type": "discrete",
                "address": 0,
                "type": "switch",
                "sporadic": true,
                "enabled": false,
                "group": "g_button"
            },

            {% set presses = ["single", "long", "double", "shortlong"] -%}
            {% for press in presses -%}
            {
                "id": "button_{{ press }}_press_counter",
                "name": "Button {{ press | capitalize }} Press Counter",
                "reg_type": "discrete",
                "address": {{ 464 + loop.index0 * 16 }},
                "type": "switch",
                "sporadic": true,
                "enabled": false,
                "group": "g_button"
            },
            {% endfor -%}

            {# Диагностика -#}
            {
                "id": "heater_state",
                "name": "Heater State",
                "type": "switch",
                "read_only": true,
                "reg_type": "discrete",
                "address": 16,
                "group": "gg_debug_heater"
            },
            {
                "id": "heater_force_control",
                "name": "Heater Force Control",
                "type": "switch",
                "reg_type": "coil",
                "address": 32,
                "group": "gg_debug_heater"
            },
            {
                "id": "heater_force_control_state",
                "name": "Heater Force Control State",
                "type": "switch",
                "reg_type": "coil",
                "address": 33,
                "group": "gg_debug_heater"
            },
            {
                "id": "charge_force_start",
                "name": "Charge Force Start",
                "type": "pushbutton",
                "reg_type": "coil",
                "address": 33,
                "group": "gg_debug_charge_discharge"
            },
            {
                "id": "charger_current_setpoint",
                "name": "Charger Current Setpoint",
                "units": "mA",
                "reg_type": "input",
                "address": 64,
                "group": "gg_debug_charge_discharge"
            },
            {
                "id": "discharger_voltage_setpoint",
                "name": "Discharger Voltage Setpoint",
                "units": "V",
                "reg_type": "input",
                "scale": 0.001,
                "address": 65,
                "group": "gg_debug_charge_discharge"
            },
            {
                "id": "discharge_current_limit",
                "name": "Discharge Current Limit",
                "units": "A",
                "reg_type": "holding",
                "scale": 0.001,
                "address": 66,
                "group": "gg_debug_charge_discharge"
            },
            {
                "id": "vinreg",
                "name": "VINREG",
                "type": "switch",
                "reg_type": "coil",
                "address": 33,
                "group": "gg_debug_charge_discharge"
            },
            {
                "id": "vinreg_setpoint",
                "name": "VINREG Setpoint",
                "units": "V",
                "reg_type": "holding",
                "scale": 0.001,
                "address": 67,
                "group": "gg_debug_charge_discharge"
            },

            {% set chips = ["charger", "discharger"] -%}
            {% set values = ["vbus", "vbat", "ibus", "ibat"] -%}
            {% set types = ["raw", "real"] -%}

            {% for type in types -%}
            {% set type_loop = loop -%}
            {% for chip in chips -%}
            {% set chip_loop = loop -%}
            {% for value in values -%}
            {
                "id": "{{ chip }}_{{ value }}_{{ type }}",
                "name": "{{ chip.capitalize() }} {{ value.capitalize() }} {{ type.capitalize() }}",
                "reg_type": "input",
                "address": {{ 0x400 + type_loop.index0 * 0x20 + chip_loop.index0 * 0x10 + loop.index0 }},
                "type": "value",
                {% if type == "real" -%}
                "scale": 0.001,
                "units": "{{ "V" if value.startswith("v") else "A" }}",
                {% else -%}
                "scale": 1,
                {% endif -%}
                "group": "gg_debug_chip_adc"
            },
            {% endfor -%}
            {% endfor -%}
            {% endfor -%}

            {
                "id": "serial",
                "name": "Serial",
                "type": "text",
                "reg_type": "input",
                "address": 270,
                "format": "u32",
                "group": "hw_info"
            },
            {
                "id": "fw_version",
                "name": "FW Version",
                "reg_type": "input",
                "address": 250,
                "type": "text",
                "format": "string",
                "string_data_size": 16,
                "enabled": false,
                "group": "hw_info"
            },
            {
                "id": "uptime",
                "name": "Uptime",
                "reg_type": "input",
                "address": 104,
                "units": "s",
                "format": "u32",
                "enabled": false,
                "group": "hw_info"
            },
            {
                "id": "mcu_temperature",
                "name": "MCU Temperature",
                "reg_type": "input",
                "address": 124,
                "units": "deg C",
                "format": "s16",
                "scale": 0.1,
                "enabled": false,
                "group": "hw_info"
            },
            {
                "id": "mcu_voltage",
                "name": "MCU Voltage",
                "reg_type": "input",
                "address": 123,
                "scale": 0.001,
                "units": "V",
                "enabled": false,
                "group": "hw_info"
            }
        ],
        "translations": {
            "en": {
                "template_title": "{{ title_en }}",

                "baud_rate_description": "Make sure that communication with device is established before changing this parameter. Select required baud rate, save configuration and then change port baud rate to the same value."
            },
            "ru": {
                "template_title": "{{ title_ru }}",
                "General": "Общее",
                "HW Info": "Данные модуля",
                "Debug": "Диагностика",
                "Baud Rate": "Скорость обмена",
                "baud_rate_description": "Перед изменением параметра убедитесь, что связь с устройством установлена. Выберите нужную скорость обмена, сохраните конфигурацию, а затем укажите в настройках порта эту же скорость.",

                "Output Voltage When Powered Up by Button (V)": "Выходное напряжение при включении кнопкой (В)",

                "g_button_description": "Кнопка на модуле WB-UPS v.3 может использоваться для управления другими устройствами через правила.<br><br>При наличии внешнего питания кнопка не выполняет никаких действий на модуле WB-UPS v.3.<br>При отсутствии внешнего питания длинное нажатие отключает WB-UPS v.3.<br><br>Параметры нажатий фиксированы:<br>- время длинного нажатия: 2000 мс<br>- время ожидания второго нажатия: 300 мс<br><br>",
                "g_output_voltage_description": "Выходное напряжение при включении кнопкой всегда 12 В.<br>В автоматическом режиме выходное напряжение автоматически подстраивается под входное.<br>В ручном режиме при понижении входного напряжения ниже заданного уровня включается резервное питание.",

                "Uninterruptible Power Supply": "Резервное питание",
                "Mode": "Режим",
                "Automatic": "Автоматический",
                "Manual": "Ручной",
                "Output Voltage (V)": "Выходное напряжение (В)",
                "Charging Current (A)": "Ток заряда (А)",

                "Battery Status": "Статус батареи",
                "Temperature Status": "Статус температуры",
                "Input Voltage": "Входное напряжение",
                "Output Voltage": "Выходное напряжение",
                "Battery Voltage": "Напряжение батареи",
                "Battery Current": "Ток батареи",
                "Input Current for Charging": "Входной ток для заряда",
                "Load Current when Powered from Battery": "Ток нагрузки при питании от батареи",
                "Battery Temperature": "Температура батареи",
                "Battery Capacity": "Уровень заряда батареи",



                "Button": "Кнопка",
                "Button State": "Состояние кнопки",
                "Button Single Press Counter": "Счетчик одиночных нажатий",
                "Button Long Press Counter": "Счетчик длинных нажатий",
                "Button Double Press Counter": "Счетчик двойных нажатий",
                "Button Shortlong Press Counter": "Счетчик коротких, а затем длинных нажатий",

                "Serial": "Серийный номер",
                "FW Version": "Версия прошивки",
                "Uptime": "Время работы с момента включения",
                "MCU Temperature": "Температура МК",
                "MCU Voltage": "Напряжение питания МК",
                "Status LED": "Индикатор состояния"
            }
        }
    }
}
